"use client";

import { useEffect } from "react";
import Link from "next/link";
import {
  ArrowLeft,
  ArrowRight,
  ChevronRight,
  Download,
  ExternalLink,
  FileText,
  AlertTriangle,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import type { ContentBlock, Course, Unit, Assignment, Feedback } from "@/lib/types";
import { CanvaEmbed } from "./canva-embed";
import { ReflexionForm } from "@/components/reflexion-form";

interface UnitViewClientProps {
  course: Course;
  unit: Unit;
  blocks: ContentBlock[];
  prevUnit: Unit | null;
  nextUnit: Unit | null;
  courseId: string;
  assignment?: Assignment | null;
  existingSubmission?: {
    id: string;
    content: string;
    status: string;
    submitted_at: string;
    feedback?: Feedback[];
  } | null;
}

function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

function ContentBlockRenderer({ block }: { block: ContentBlock }) {
  const content = block.content as Record<string, unknown>;

  switch (block.type) {
    case "canva_embed":
      return <CanvaEmbed blockId={block.id} title={content.title as string} />;

    case "text":
      return (
        <div
          className="prose prose-sm max-w-none text-foreground"
          dangerouslySetInnerHTML={{
            __html: (content.html as string) || "",
          }}
        />
      );

    case "file":
      return (
        <Card className="border-l-4 border-l-primary">
          <CardContent className="flex items-center gap-4 p-5">
            <div className="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-accent">
              <FileText className="h-6 w-6 text-primary" />
            </div>
            <div className="min-w-0 flex-1">
              <p className="font-semibold text-sm">
                {(content.filename as string) ||
                  (content.fileName as string) ||
                  "Skript / Dokument"}
              </p>
              {typeof content.fileSize === "number" && (
                <p className="text-xs text-muted-foreground mt-0.5">
                  {formatFileSize(content.fileSize)}
                </p>
              )}
            </div>
            <Button asChild size="sm">
              <a
                href={(content.publicUrl as string) || (content.url as string)}
                download
                target="_blank"
                rel="noopener noreferrer"
              >
                <Download className="mr-2 h-4 w-4" />
                Herunterladen
              </a>
            </Button>
          </CardContent>
        </Card>
      );

    case "link":
      return (
        <Card className="transition-shadow hover:shadow-md">
          <CardContent className="p-4">
            <a
              href={content.url as string}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-3 text-primary hover:underline"
            >
              <ExternalLink className="h-5 w-5 shrink-0" />
              <span className="text-sm font-medium">
                {(content.title as string) || (content.url as string)}
              </span>
            </a>
          </CardContent>
        </Card>
      );

    default:
      return (
        <Card className="border-destructive/20">
          <CardContent className="flex items-center gap-3 p-4 text-muted-foreground">
            <AlertTriangle className="h-5 w-5" />
            <span className="text-sm">
              Unbekannter Inhaltstyp: {block.type}
            </span>
          </CardContent>
        </Card>
      );
  }
}

export function UnitViewClient({
  course,
  unit,
  blocks,
  prevUnit,
  nextUnit,
  courseId,
  assignment,
  existingSubmission,
}: UnitViewClientProps) {
  // Scroll to top when unit changes
  useEffect(() => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }, [unit.id]);

  return (
    <div className="relative animate-fade-in">
      <div className="p-6 lg:p-8 max-w-5xl pb-24">
        {/* Breadcrumb */}
        <nav className="mb-6 flex items-center gap-1.5 text-xs text-muted-foreground">
          <Link
            href="/dashboard"
            className="hover:text-foreground transition-colors"
          >
            Dashboard
          </Link>
          <ChevronRight className="h-3 w-3" />
          <Link
            href={`/courses/${courseId}`}
            className="hover:text-foreground transition-colors truncate max-w-[200px]"
          >
            {course.name}
          </Link>
          <ChevronRight className="h-3 w-3" />
          <span className="text-foreground font-medium truncate max-w-[200px]">
            {unit.name}
          </span>
        </nav>

        {/* Unit title */}
        <div className="mb-10">
          <h1 className="text-2xl font-bold tracking-tight lg:text-3xl text-foreground">
            {unit.name}
          </h1>
          <div className="mt-2 h-1 w-12 rounded-full bg-primary/60" />
        </div>

        {/* Content blocks */}
        {blocks.length === 0 ? (
          <div className="rounded-xl border border-dashed border-border/50 p-16 text-center bg-muted/20">
            <FileText className="mx-auto mb-4 h-10 w-10 text-muted-foreground/30" />
            <p className="text-muted-foreground text-sm">
              Dieser Tag hat noch keine Inhalte.
            </p>
          </div>
        ) : (
          <div className="space-y-10">
            {blocks.map((block) => (
              <ContentBlockRenderer key={block.id} block={block} />
            ))}
          </div>

          {/* Reflexion section */}
          {assignment && (
            <div className="mt-12 pt-8 border-t border-border/50">
              <ReflexionForm
                assignment={assignment}
                existingSubmission={existingSubmission}
              />
            </div>
          )}
        )}
      </div>

      {/* Sticky Prev/Next navigation bar */}
      {(prevUnit || nextUnit) && (
        <div className="sticky bottom-0 left-0 right-0 z-30 border-t border-border bg-white/95 backdrop-blur-sm px-6 py-3 lg:px-8">
          <div className="flex items-center justify-between gap-4 max-w-5xl">
            {prevUnit ? (
              <Button asChild variant="outline" size="sm">
                <Link href={`/courses/${courseId}/units/${prevUnit.id}`}>
                  <ArrowLeft className="mr-2 h-4 w-4" />
                  <span className="hidden sm:inline truncate max-w-[180px]">
                    {prevUnit.name}
                  </span>
                  <span className="sm:hidden">Zur√ºck</span>
                </Link>
              </Button>
            ) : (
              <div />
            )}
            {nextUnit ? (
              <Button asChild size="sm">
                <Link href={`/courses/${courseId}/units/${nextUnit.id}`}>
                  <span className="hidden sm:inline truncate max-w-[180px]">
                    {nextUnit.name}
                  </span>
                  <span className="sm:hidden">Weiter</span>
                  <ArrowRight className="ml-2 h-4 w-4" />
                </Link>
              </Button>
            ) : (
              <div />
            )}
          </div>
        </div>
      )}
    </div>
  );
}
